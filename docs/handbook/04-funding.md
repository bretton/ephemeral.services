# Funding

## Multiple Deposits

When open a new channel, the entire input tx is used. If the channel is smaller than the size of the input, the remainder bitcoin are locked until 3 blocks have confirmed. Only then can a new channel be opened with the balance.

You can mitigate delays in opening several channels by funding your node in several smaller transactions, at a higher transaction cost, and benefit of opening multiple channels at once and having them go live within 3 blocks.

Or you can fund your node with a single large transaction, and spend several hours opening up 5 or more channels.

## Funding to bech32

We want to ensure our node is funded on bech32 addy, or with `lnd` known as `lncli newaddress p2wkh`

We also want to ensure multiple inputs, so several funding transactions, in order to open multiple channels simultaneously. 

This means funding n bech32 addresses with 0.3 btc ($1000 @ 2018-12-18 prices) split into 0.03 transaction sizes. 

## Funding bitcoind, then bech32

Not all exchanges and wallets will support sending bitcoin directly to an address generated by a LN node. You may be required to first send Bitcoin to your bitcoind node with a regular bitcoin address, and them from there send to your LN node with a bech32 address.

You can do a single funding transaction to bitcoind, and 10 funding transactions to LN.

## What does this cost?

We have a known potential fee range for a regular sized transaction of:

Tier       | Values
---------- | ----------
Low      | 0.00001350 BTC
Normal | 0.00007232 BTC (5 times higher)
High     | 0.00204945 BTC (150 times higher)

Each bitcoind funding transaction to a normal pre-segwit address can cost 0.00001350 to 0.00204945 BTC.

Each LN funding transaction to a bech32 address can cost 0.00002213 to 0.00334163 BTC.

A sample funding round of several transactions follows, with the total fees to open a $10 channel, funded from non-segwit wallet, to bitcoind, to LND, and open channel = (0.00003778+0.00002213+0.00002787) = 0.00008778 BTC, and time taken 3 hours because fees were lower than required. 

Perhaps ten bech32 funding transactions could be batched for lower fees?

Alternatively, you may be looking at 0.00022130 BTC in fees to fund ten (10) bech32 inputs for your LN node to be able to open 10 channels at once. 

To recap:

* exchange to bitcoind: 0.00007232 BTC 
* plus bitcoind to ln node batched/ten times: 0.00002213 to 0.00022130 BTC
* plus channel opening fee 1% capacity times ten for total of: 0.00027870 BTC

Total fees for ten ~$100 channels after two funding rounds from legacy to bitcoind to bech32 on LN node is likely up to 0.00057232 BTC, or $2.00, at current prices, without batching. With batching it may be considerably less.

As long as fees are low, this is a feasible approach. However if fees rise 10x, or 150x, re-evaluation may be needed.

### More detail on batched transaction fees

The average transaction size is 226 bytes + 60 bytes overhead for batched transactions + 4 bytes error-margin rounding = 290 bytes for a batched transaction.

However, from https://www.reddit.com/r/btc/comments/7pzzvz/calculate_the_bitcoin_transaction_fee/dslbsj7
```
Use this to figure out how many bytes your tx will be:

(# of inputs)x180 + (# of outputs)x34 + 10 (+/- # of inputs) = total bytes

EXP:

If your transaction had 7 inputs and 1 output it would be like this:

7(times)180 + 1(times)34 + 10 + 7(for safe measure) = 1311 bytes

510 satoshis * 1311 = .0066861 BTC tx fee ($90ish)
```

So if we fund our bitcoin node with 0.33 bitcoin in a single transaction, then fund the LN node via batch transaction to 10 outputs, it would cost:

(1*180)+(10*34)+10+7 = 180+340+17 = 537 bytes.

sats/byte | transaction fee
------ | ------
10  | 5370 satoshis
20  | 10740 satoshis
50  | 26850 satoshis
100 | 53700 satoshis
ATH | 805500 satoshis

We can force higher fees to ensure faster confirmations, simply by doubling low fees amounts, for example any regular fee under 80 sats/byte could easily be replaced by paying 100 sats/byte for a batch transaction fee of 53700 sats, or 0.00053700, or around $2 at current Bitcoin prices, and still be affordable relative to the total sum being committed. 

Conclusion: 10 x $100 channels, for $1000 outgoing capacity, funded for $2 is possible? Here's proof (to-do)

To-do: add a sample batched transaction with fee calcs verifiable on an explorer

## LN Node Funding Script
To-do:
* review https://en.bitcoin.it/wiki/Techniques_to_reduce_transaction_fees
* build a script to fund 10 LN bech32 wallet addresses in a single batched transaction, by obtaining 10 addresses, calculating 1/10th balances to send, and sending in a single transaction

Pseudocode:
```
# send funds to your bitcoin node. then fund your LN node with this tool
echo blurb about this tool with warnings and confirmations required to run

# we want to fund 3 nodes with 0.33btc each, where 0.33btc is split to 10 addresses on each node
check: if bitcoind balance is > 0.33 btc; else exit
create: change address on bitcoind node

# get a list of addresses from LN node
gRPC/shell query looped 10x, with each bech32 address becoming an item in an array

# get the current median fee, and add to it for faster confirmations
query: https://bitcoinfees.earn.com/api for fastestfee
optionally set: extra = +5%
calculate: fastestfee+extra = ourfee

# compute
split 0.33 into (10 amounts) plus (batch fee from ourfee) [537 bytes @ fast tx fee with optional extra for speedier confirmations]
set perchannel = (bitcoind-balance - batch fee)/10

# https://bitcoin.org/en/developer-reference#sendmany
send the computed value perchannel to each of the address in the previous array as a single batched transaction
send any change to change address computed earlier in script
```

Run this script 3 times. Or perhaps script can fund 3 nodes at once?

## How long does it take?

It can take anything from 30 to 360 minutes to fund your node in a manual fashion outlined in this document. 

It might only take 20mins with the correct scripting to get 10 inputs you can spend collectively, then wait another 30 minutes to be live on the LN with 10 active channels. This might be worth it, compared to several hours of sequential channel opening. 

## Outgoing Channels

10 * channels of $100, of which two are channels to our other nodes.

## Incoming Channels

Any number of $10+ to max channels




